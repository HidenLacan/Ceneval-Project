<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Empleado - Sistema de Rutas</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .dashboard-container {
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .main-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2c3e50;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-title {
            color: #2c3e50;
            font-weight: 700;
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .section-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Estilo para el selector de rutas */
        .route-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .route-selector select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .route-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .route-selector select:hover {
            border-color: #667eea;
        }
        
        .data-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-box h5 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .data-box p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .map-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .map-container.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .route-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .route-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .route-btn.individual {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .route-btn.shared {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .route-btn.active {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .right-section {
            border: 2px solid #dc3545;
            border-radius: 15px;
            padding: 20px;
        }
        

        

        
        .no-routes {
            text-align: center;
            color: #6c757d;
            font-size: 1.2rem;
            padding: 50px 20px;
        }
        
        .no-routes i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
            display: block;
        }
        
        .no-routes h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        /* Chat Styles - Modernizado */
        .chat-area {
            height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 3px solid rgba(102, 126, 234, 0.2);
            margin-bottom: 25px;
            position: relative;
        }
        
        .chat-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .chat-header h5 {
            margin: 0;
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header h5 i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.4rem;
        }
        
        .chat-badge {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .chat-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .chat-placeholder i {
            font-size: 4rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .chat-placeholder p {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin-bottom: 20px;
            min-height: 350px;
            max-height: 450px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }
        
        .message.own::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: #667eea;
            border-bottom: none;
            border-right: none;
        }
        
        .message.other {
            background: white;
            color: #333;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-bottom-left-radius: 5px;
        }
        
        .message.other::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message.system {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #6c757d;
            text-align: center;
            font-style: italic;
            margin: 15px auto;
            max-width: 95%;
            border: 1px dashed rgba(102, 126, 234, 0.3);
            border-radius: 15px;
        }
        
        .message-header {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .message-content {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .quick-msg-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .quick-msg-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .quick-msg-btn:hover::before {
            left: 100%;
        }
        
        .quick-msg-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .quick-msg-btn i {
            margin-right: 8px;
        }
        
        .chat-input {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .chat-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }
        
        .chat-input input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        .chat-input button {
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-size: 1.1rem;
        }
        
        .chat-input button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .chat-input button:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .data-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .main-header {
                padding: 25px;
            }
            
            .main-title {
                font-size: 2.2rem;
            }
            
            .section-container {
                padding: 25px;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .main-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                padding: 20px;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .logout-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .section-container {
                padding: 20px;
                height: auto;
                min-height: 500px;
            }
            
            .data-box {
                padding: 15px;
            }
            
            .data-box h5 {
                font-size: 0.9rem;
            }
            
            .data-box p {
                font-size: 0.8rem;
            }
            
            .map-container {
                height: 300px;
            }
            
            .route-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .route-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .quick-msg-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            
            .chat-messages {
                min-height: 250px;
                max-height: 300px;
            }
            
            .message {
                max-width: 90%;
                padding: 10px 12px;
            }
            
            .chat-input input {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .chat-input button {
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .main-header {
                padding: 15px;
                gap: 15px;
            }
            
            .main-title {
                font-size: 1.6rem;
            }
            
            .logout-btn {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
            
            .section-container {
                padding: 15px;
                min-height: 400px;
            }
            
            .data-box {
                padding: 12px;
            }
            
            .data-box h5 {
                font-size: 0.8rem;
            }
            
            .data-box p {
                font-size: 0.7rem;
            }
            
            .map-container {
                height: 250px;
            }
            
            .route-btn {
                padding: 10px;
                font-size: 0.8rem;
            }
            
            .quick-msg-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .chat-messages {
                min-height: 200px;
                max-height: 250px;
                padding: 10px;
            }
            
            .message {
                max-width: 95%;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .chat-input input {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .chat-input button {
                padding: 8px 10px;
            }
            
            .no-routes {
                padding: 30px 15px;
            }
            
            .no-routes h3 {
                font-size: 1.1rem;
            }
            
            .no-routes p {
                font-size: 0.9rem;
            }
        }
        
        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para la secci√≥n de rutas asignadas */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* Estilo espec√≠fico para la secci√≥n de rutas asignadas */
        .section-container.rutas-asignadas {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .section-container.rutas-asignadas .rutas-grid {
            max-height: 300px;
            overflow-y: auto;
        }

        .section-header h3 {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .rutas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .ruta-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .ruta-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .ruta-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .ruta-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin: 0;
        }

        .ruta-estado {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .ruta-estado.pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .ruta-estado.completada {
            background: #d4edda;
            color: #155724;
        }

        .ruta-info {
            margin-bottom: 15px;
        }

        .ruta-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .ruta-info-label {
            color: #6c757d;
            font-weight: 500;
        }

        .ruta-info-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .ruta-actions {
            display: flex;
            gap: 10px;
        }

        .btn-completar {
            flex: 1;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-completar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-completar:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-ver-detalles {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-ver-detalles:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .loading-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .loading-placeholder i {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
        }

        .no-rutas-message {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .no-rutas-message i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        /* Modal para completar ruta */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-cancelar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-confirmar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-confirmar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <div class="dashboard-container" data-user-id="{{ request.user.id }}">
        <!-- Header -->
        <div class="main-header">
            <h1 class="main-title">
                <i class="fas fa-user-tie"></i> EMPLEADO
            </h1>
            <button class="logout-btn" onclick="confirmLogout()" title="Cerrar Sesi√≥n">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        {% if rutas_asignadas %}
        <!-- Route Selector -->
        <div class="route-selector">
            <select id="routeSelector">
                {% for ruta in rutas_asignadas %}
                <option value="{{ ruta.id }}" 
                        data-colonia="{{ ruta.colonia.nombre }}"
                        data-estado="{{ ruta.estado }}"
                        data-empleados="{{ ruta.empleados_asignados.count }}">
                    {{ ruta.colonia.nombre }} - {{ ruta.fecha_creacion|date:"d/m/Y H:i" }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Mis Rutas Asignadas -->
        <div class="section-container rutas-asignadas">
            <div class="section-header">
                <h3><i class="fas fa-route"></i> Mis Rutas Asignadas</h3>
                <button class="refresh-btn" onclick="cargarMisRutas()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
            <div id="misRutasContainer" class="rutas-grid">
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando mis rutas...</p>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Left Section - Route Information and Map -->
            <div class="main-section">
                <div class="section-container">
                    <!-- Data Display Area -->
                    <div class="data-grid">
                        <div class="data-box">
                            <h5><i class="fas fa-map-marker-alt"></i> Datos de la colonia</h5>
                            <p id="coloniaNombre">{{ ruta_actual.colonia.nombre }}</p>
                            <p><strong>Estado:</strong> <span id="rutaEstado" class="status-badge status-{{ ruta_actual.estado }}">{{ ruta_actual.estado|title }}</span></p>
                        </div>
                        <div class="data-box">
                            <h5><i class="fas fa-users"></i> Datos de la ruta</h5>
                            <p><strong>Personas en el equipo:</strong> <span id="empleadosCount">{{ empleados_equipo.count }}</span></p>
                            <p><strong>Tiempo estimado:</strong> <span id="tiempoEstimado">{{ ruta_actual.tiempo_calculado|default:"No calculado" }}</span></p>
                        </div>
                    </div>

                    <!-- Map Visualization Area -->
                    <div class="map-container" id="mapContainer">
                        <div class="text-center">
                            <i class="fas fa-map fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Visualizaci√≥n de mapa de ruta</p>
                            <p class="text-muted">Selecciona una opci√≥n de visualizaci√≥n</p>
                        </div>
                    </div>

                    <!-- Route Selection Buttons -->
                    <div class="route-buttons">
                        <button class="route-btn individual" id="btnIndividual">
                            <i class="fas fa-user"></i> Ruta Individual
                            <br><small>Solo se muestra la ruta del empleado</small>
                        </button>
                        <button class="route-btn shared" id="btnShared">
                            <i class="fas fa-users"></i> Ruta Compartida
                            <br><small>Se muestran ambas rutas</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Section - Chat -->
            <div class="chat-section">
                <div class="section-container">
                    <!-- Chat Area -->
                    <div class="chat-area" id="chatArea">
                        <div class="chat-header">
                            <h5><i class="fas fa-comments"></i> Chat de Equipo</h5>
                            <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
                        </div>
                        
                        <!-- Mensajes del Chat -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-placeholder">
                                <i class="fas fa-comments"></i>
                                <p>Selecciona una ruta para ver los mensajes</p>
                                <small>Comun√≠cate con tu equipo en tiempo real</small>
                            </div>
                        </div>
                        
                        <!-- Acciones R√°pidas -->
                        <div class="quick-actions" id="quickActions" style="display: none;">
                            <button class="quick-msg-btn" data-message="‚úÖ Llegu√© a mi zona">
                                <i class="fas fa-check"></i> Llegu√©
                            </button>
                            <button class="quick-msg-btn" data-message="‚è∏Ô∏è Tomando descanso">
                                <i class="fas fa-pause"></i> Pausa
                            </button>
                            <button class="quick-msg-btn" data-message="‚ùå Tengo un problema">
                                <i class="fas fa-exclamation"></i> Problema
                            </button>
                            <button class="quick-msg-btn" data-message="‚úÖ Termin√© mi √°rea">
                                <i class="fas fa-flag-checkered"></i> Termin√©
                            </button>
                        </div>
                        
                        <!-- Input de Mensaje -->
                        <div class="chat-input" id="chatInput" style="display: none;">
                            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." maxlength="1000">
                            <button id="sendMessageBtn" title="Enviar mensaje">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- No Routes Assigned -->
        <div class="section-container">
            <div class="no-routes">
                <i class="fas fa-route"></i>
                <h3>No tienes rutas asignadas</h3>
                <p>Contacta con tu supervisor para que te asigne una ruta de trabajo.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando datos de la ruta...</p>
    </div>

    <!-- Modal para completar ruta -->
    <div class="modal-overlay" id="completarRutaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle"></i> Marcar Ruta como Completada
                </h3>
                <button class="modal-close" onclick="cerrarModalCompletar()">&times;</button>
            </div>
            <form id="formCompletarRuta">
                <div class="form-group">
                    <label class="form-label">Colonia:</label>
                    <input type="text" id="modalColonia" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Tiempo Real (minutos):</label>
                    <input type="number" id="modalTiempoReal" class="form-input" min="1" max="480" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Inicio (opcional):</label>
                    <input type="datetime-local" id="modalFechaInicio" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Notas (opcional):</label>
                    <textarea id="modalNotas" class="form-textarea" placeholder="Agrega notas sobre la ruta completada..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancelar" onclick="cerrarModalCompletar()">Cancelar</button>
                    <button type="submit" class="btn-confirmar">
                        <i class="fas fa-check"></i> Confirmar Completado
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let currentMap = null;
        let currentRouteData = null;
        let currentViewMode = 'individual'; // 'individual' or 'shared'
        const currentUserId = parseInt(document.querySelector('.dashboard-container').dataset.userId) || null;
        
        // Chat variables
        let currentChatRouteId = null;
        let lastMessageId = 0;
        let chatCheckInterval = null;
        
        // CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Clean previous map scripts
        function cleanMapScripts() {
            console.log('üßπ Limpiando scripts de mapas anteriores');
            const scripts = document.querySelectorAll('script[data-map-script]');
            scripts.forEach(script => {
                script.remove();
            });
            console.log('‚úÖ Scripts de mapas anteriores eliminados');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando dashboard del empleado');
            console.log('üë§ Usuario actual ID:', currentUserId);
            console.log('üéØ Modo de vista inicial:', currentViewMode);
            
            // Check if routes are available (set by Django template)
            const hasRoutes = {% if rutas_asignadas %}true{% else %}false{% endif %};
            
            if (hasRoutes) {
                console.log('‚úÖ Hay rutas asignadas disponibles');
                
                // Set initial route
                const initialRouteId = document.getElementById('routeSelector').value;
                console.log('üîÑ Ruta inicial seleccionada:', initialRouteId);
                
                if (initialRouteId) {
                    loadRouteData(initialRouteId);
                } else {
                    console.warn('‚ö†Ô∏è No hay ruta inicial seleccionada');
                }
                
                // Set initial button state
                setViewMode('individual'); // Start with individual mode
                
                // Event listeners
                document.getElementById('routeSelector').addEventListener('change', function() {
                    const routeId = this.value;
                    console.log('üîÑ Cambio de ruta seleccionada:', routeId);
                    loadRouteData(routeId);
                });
                
                document.getElementById('btnIndividual').addEventListener('click', function() {
                    console.log('üë§ Cambiando a modo individual');
                    setViewMode('individual');
                });
                
                document.getElementById('btnShared').addEventListener('click', function() {
                    console.log('üë• Cambiando a modo compartido');
                    setViewMode('shared');
                });
            } else {
                console.log('‚ö†Ô∏è No hay rutas asignadas para este empleado');
            }
            
            // Cargar rutas asignadas al inicializar
            cargarMisRutas();
            
            // Event listener para el formulario de completar ruta
            document.getElementById('formCompletarRuta').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const rutaId = parseInt(document.getElementById('completarRutaModal').dataset.rutaId);
                const tiempoReal = parseFloat(document.getElementById('modalTiempoReal').value);
                const fechaInicio = document.getElementById('modalFechaInicio').value;
                const notas = document.getElementById('modalNotas').value;
                
                if (!tiempoReal || tiempoReal <= 0) {
                    alert('Por favor ingresa un tiempo real v√°lido');
                    return;
                }
                
                marcarRutaCompletada(rutaId, tiempoReal, fechaInicio, notas);
            });
            
            // Cerrar modal al hacer clic fuera de √©l
            document.getElementById('completarRutaModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModalCompletar();
                }
            });
            
            console.log('‚úÖ Dashboard inicializado correctamente');
        });

        // Load route data
        function loadRouteData(routeId) {
            console.log('üîÑ Iniciando carga de datos para ruta ID:', routeId);
            showLoading(true);
            
            const formData = new FormData();
            formData.append('ruta_id', routeId);
            
            console.log('üì§ Enviando request a /accounts/obtener_ruta_empleado/');
            
            fetch('/accounts/obtener_ruta_empleado/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('üì• Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Datos recibidos:', data);
                
                if (data.error) {
                    console.error('‚ùå Error en datos:', data.error);
                    showMessage('Error: ' + data.error, 'error');
                } else {
                    console.log('‚úÖ Datos v√°lidos recibidos');
                    console.log('üó∫Ô∏è mapa_html presente:', !!data.mapa_html);
                    console.log('üó∫Ô∏è mapa_calculado presente:', !!data.mapa_calculado);
                    
                    currentRouteData = data;
                    updateRouteInfo(data);
                    renderMap(data);
                    
                    // Initialize chat for this route
                    initializeChat(routeId);
                }
            })
            .catch(error => {
                console.error('‚ùå Error en fetch:', error);
                showMessage('Error al cargar datos de la ruta', 'error');
            })
            .finally(() => {
                console.log('üèÅ Finalizando carga de datos');
                showLoading(false);
            });
        }

        // Update route information display
        function updateRouteInfo(data) {
            console.log('üìä Actualizando informaci√≥n de la ruta');
            console.log('üèòÔ∏è Colonia:', data.colonia);
            console.log('üìà Estado:', data.estado);
            console.log('üë• Empleados:', data.empleados);
            console.log('‚è±Ô∏è Tiempo calculado:', data.tiempo_calculado);
            
            try {
                document.getElementById('coloniaNombre').textContent = data.colonia.nombre;
                document.getElementById('rutaEstado').textContent = data.estado;
                document.getElementById('rutaEstado').className = `status-badge status-${data.estado}`;
                document.getElementById('empleadosCount').textContent = data.empleados.length;
                document.getElementById('tiempoEstimado').textContent = data.tiempo_calculado || 'No calculado';
                
                console.log('‚úÖ Informaci√≥n de ruta actualizada correctamente');
            } catch (error) {
                console.error('‚ùå Error al actualizar informaci√≥n de ruta:', error);
            }
        }

        // Render map
        function renderMap(data) {
            console.log('üó∫Ô∏è Iniciando renderizado del mapa');
            console.log('üìä Datos recibidos en renderMap:', {
                tiene_mapa_html: !!data.mapa_html,
                tiene_mapa_calculado: !!data.mapa_calculado,
                tiene_centro_colonia: !!(data.mapa_calculado && data.mapa_calculado.centro_colonia),
                tiene_rutas: !!(data.mapa_calculado && data.mapa_calculado.rutas)
            });
            
            const mapContainer = document.getElementById('mapContainer');
            console.log('üìç Contenedor del mapa encontrado:', !!mapContainer);
            
            // Clear previous map and scripts
            if (currentMap) {
                console.log('üßπ Limpiando mapa anterior');
                currentMap.remove();
                currentMap = null;
            }
            
            // Clean previous map scripts
            cleanMapScripts();
            
            // Check if we have HTML map content from database
            if (data.mapa_html && currentViewMode === 'shared') {
                console.log('‚úÖ Usando mapa HTML desde la base de datos (modo compartido)');
                console.log('üìÑ Longitud del HTML:', data.mapa_html.length);
                console.log('üìÑ Primeros 200 caracteres del HTML:', data.mapa_html.substring(0, 200));
                
                try {
                    // Limpiar el contenedor primero
                    mapContainer.innerHTML = '';
                    
                    // Crear un elemento temporal para procesar el HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.mapa_html;
                    
                    // Buscar el div del mapa en el HTML
                    const mapDiv = tempDiv.querySelector('.folium-map');
                    if (mapDiv) {
                        console.log('üìç Div del mapa encontrado en HTML');
                        
                        // Cambiar el ID para evitar conflictos
                        const newId = 'map_' + Date.now();
                        mapDiv.id = newId;
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '600px';
                        
                        // Extraer y procesar el JavaScript ANTES de insertar el HTML
                        const scripts = tempDiv.querySelectorAll('script');
                        let processedScripts = [];
                        
                        scripts.forEach((script, index) => {
                            console.log(`üìú Procesando script ${index + 1}`);
                            
                            // Reemplazar el ID del mapa en el JavaScript de forma m√°s espec√≠fica
                            let scriptContent = script.textContent;
                            // Reemplazar referencias al ID del mapa de forma m√°s precisa
                            scriptContent = scriptContent.replace(/L\.map\s*\(\s*["'][^"']*["']/g, `L.map("${newId}"`);
                            scriptContent = scriptContent.replace(/map_[a-zA-Z0-9_]+/g, newId);
                            
                            processedScripts.push(scriptContent);
                            console.log(`‚úÖ Script ${index + 1} procesado con ID: ${newId}`);
                        });
                        
                        // Insertar el div procesado
                        mapContainer.appendChild(mapDiv);
                        
                        // Esperar un momento para asegurar que el DOM est√© listo
                        setTimeout(() => {
                            console.log('‚è≥ DOM listo, ejecutando scripts...');
                            
                            // Verificar que el elemento del mapa existe
                            const mapElement = document.getElementById(newId);
                            if (!mapElement) {
                                console.error(`‚ùå Elemento del mapa con ID ${newId} no encontrado`);
                                return;
                            }
                            console.log(`‚úÖ Elemento del mapa encontrado: ${newId}`);
                            
                            // Ejecutar los scripts procesados DESPU√âS de insertar el HTML
                            processedScripts.forEach((scriptContent, index) => {
                                console.log(`üöÄ Ejecutando script procesado ${index + 1}`);
                                
                                try {
                                    const newScript = document.createElement('script');
                                    newScript.textContent = scriptContent;
                                    newScript.setAttribute('data-map-script', 'true');
                                    document.head.appendChild(newScript);
                                    
                                    console.log(`‚úÖ Script ${index + 1} ejecutado`);
                                } catch (scriptError) {
                                    console.error(`‚ùå Error ejecutando script ${index + 1}:`, scriptError);
                                }
                            });
                            
                            console.log('‚úÖ Todos los scripts ejecutados');
                        }, 100);
                        
                        console.log('‚úÖ HTML procesado y renderizado correctamente');
                    } else {
                        console.warn('‚ö†Ô∏è No se encontr√≥ div del mapa en el HTML optimizado');
                        console.log('üìÑ Contenido HTML completo:', data.mapa_html);
                        
                        // Fallback mejorado: crear contenedor e insertar script directamente
                        mapContainer.innerHTML = '';
                        
                        // Crear div del mapa manualmente
                        const mapDiv = document.createElement('div');
                        mapDiv.id = 'map_' + Date.now();
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '600px';
                        mapDiv.className = 'folium-map';
                        mapContainer.appendChild(mapDiv);
                        
                        // Extraer y ejecutar scripts
                        setTimeout(() => {
                            const scripts = tempDiv.querySelectorAll('script');
                            scripts.forEach((script, index) => {
                                try {
                                    let scriptContent = script.textContent;
                                    // Reemplazar ID en el script
                                    scriptContent = scriptContent.replace(/L\.map\s*\(\s*["'][^"']*["']/g, `L.map("${mapDiv.id}"`);
                                    scriptContent = scriptContent.replace(/map_[a-zA-Z0-9_]+/g, mapDiv.id);
                                    
                                    const newScript = document.createElement('script');
                                    newScript.textContent = scriptContent;
                                    newScript.setAttribute('data-map-script', 'true');
                                    document.head.appendChild(newScript);
                                    
                                    console.log(`‚úÖ Script fallback ${index + 1} ejecutado`);
                                } catch (error) {
                                    console.error(`‚ùå Error ejecutando script fallback ${index + 1}:`, error);
                                }
                            });
                        }, 200);
                    }
                } catch (error) {
                    console.error('‚ùå Error al procesar HTML:', error);
                    // Fallback: insertar HTML directamente
                    mapContainer.innerHTML = data.mapa_html;
                }
            } else if (currentViewMode === 'individual' && data.mapa_calculado && data.mapa_calculado.centro_colonia) {
                console.log('üéØ Forzando renderizado manual para modo individual');
                renderManualMap(data);
            } else if (data.mapa_calculado && data.mapa_calculado.centro_colonia) {
                console.log('üîÑ Usando renderizado manual del mapa');
                console.log('üéØ Modo de vista actual:', currentViewMode);
                
                const center = [
                    data.mapa_calculado.centro_colonia.center_lat,
                    data.mapa_calculado.centro_colonia.center_lon
                ];
                console.log('üìç Centro del mapa:', center);
                
                try {
                    currentMap = L.map('mapContainer').setView(center, 16);
                    console.log('‚úÖ Mapa Leaflet inicializado');
                    
                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(currentMap);
                    console.log('‚úÖ Capa de tiles agregada');
                    
                    // Add colony polygon
                    if (data.mapa_calculado.poligono_colonia) {
                        console.log('üìç Agregando pol√≠gono de colonia');
                        const polygon = L.geoJSON(data.mapa_calculado.poligono_colonia, {
                            style: {
                                color: '#3498db',
                                weight: 2,
                                fillColor: '#3498db',
                                fillOpacity: 0.1
                            }
                        }).addTo(currentMap);
                    }
                    
                    // Add routes based on current view mode
                    if (data.mapa_calculado.rutas) {
                        console.log('üõ£Ô∏è Agregando rutas, modo actual:', currentViewMode);
                        console.log('üë• Rutas disponibles:', data.mapa_calculado.rutas.length);
                        console.log('üë§ Usuario actual ID:', currentUserId);
                        
                        data.mapa_calculado.rutas.forEach((ruta, index) => {
                            console.log(`üõ£Ô∏è Procesando ruta ${index + 1}:`, {
                                empleado_id: ruta.empleado_id,
                                empleado_nombre: ruta.empleado_nombre,
                                tiene_puntos: !!(ruta.puntos && ruta.puntos.length > 0)
                            });
                            
                            if (currentViewMode === 'individual') {
                                // Show only current employee's route
                                if (ruta.empleado_id === currentUserId) {
                                    console.log('‚úÖ Agregando ruta individual del empleado actual');
                                    addRouteToMap(ruta);
                                } else {
                                    console.log('‚è≠Ô∏è Saltando ruta de otro empleado');
                                }
                            } else {
                                // Show all routes
                                console.log('‚úÖ Agregando ruta compartida');
                                addRouteToMap(ruta);
                            }
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error en renderizado manual:', error);
                }
            } else {
                console.log('‚ùå No hay datos de mapa disponibles');
                console.log('üìä Estado de datos:', {
                    mapa_html: data.mapa_html,
                    mapa_calculado: data.mapa_calculado,
                    centro_colonia: data.mapa_calculado?.centro_colonia
                });
                
                mapContainer.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted">No hay datos de mapa disponibles</p>
                        <p class="text-muted small">Debug: mapa_html=${!!data.mapa_html}, mapa_calculado=${!!data.mapa_calculado}</p>
                    </div>
                `;
            }
            
            console.log('üèÅ Renderizado del mapa completado');
        }

        // Render manual map (separate function for reusability)
        function renderManualMap(data) {
            console.log('üîß Renderizando mapa manual con modo:', currentViewMode);
            
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = '';
            
            const center = [
                data.mapa_calculado.centro_colonia.center_lat,
                data.mapa_calculado.centro_colonia.center_lon
            ];
            console.log('üìç Centro del mapa:', center);
            
            try {
                // Crear nuevo contenedor para el mapa
                const mapDiv = document.createElement('div');
                mapDiv.id = 'manual_map_' + Date.now();
                mapDiv.style.width = '100%';
                mapDiv.style.height = '500px';
                mapContainer.appendChild(mapDiv);
                
                currentMap = L.map(mapDiv.id).setView(center, 16);
                console.log('‚úÖ Mapa Leaflet manual inicializado');
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(currentMap);
                console.log('‚úÖ Capa de tiles agregada');
                
                // Add colony polygon
                if (data.mapa_calculado.poligono_colonia) {
                    console.log('üìç Agregando pol√≠gono de colonia');
                    const polygon = L.geoJSON(data.mapa_calculado.poligono_colonia, {
                        style: {
                            color: '#3498db',
                            weight: 2,
                            fillColor: '#3498db',
                            fillOpacity: 0.1
                        }
                    }).addTo(currentMap);
                }
                
                // Add routes based on current view mode
                if (data.mapa_calculado.rutas) {
                    console.log('üõ£Ô∏è Agregando rutas manuales, modo actual:', currentViewMode);
                    console.log('üë• Rutas disponibles:', data.mapa_calculado.rutas.length);
                    console.log('üë§ Usuario actual ID:', currentUserId);
                    
                    data.mapa_calculado.rutas.forEach((ruta, index) => {
                        console.log(`üõ£Ô∏è Procesando ruta manual ${index + 1}:`, {
                            empleado_id: ruta.empleado_id,
                            empleado_nombre: ruta.empleado_nombre,
                            tiene_puntos: !!(ruta.puntos && ruta.puntos.length > 0)
                        });
                        
                        if (currentViewMode === 'individual') {
                            // Show only current employee's route
                            if (ruta.empleado_id === currentUserId) {
                                console.log('‚úÖ Agregando ruta individual manual del empleado actual');
                                addRouteToMap(ruta);
                            } else {
                                console.log('‚è≠Ô∏è Saltando ruta de otro empleado en modo manual');
                            }
                        } else {
                            // Show all routes
                            console.log('‚úÖ Agregando ruta compartida manual');
                            addRouteToMap(ruta);
                        }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error en renderizado manual:', error);
            }
        }

        // Add route to map
        function addRouteToMap(ruta) {
            console.log('üõ£Ô∏è Agregando ruta al mapa:', {
                empleado_nombre: ruta.empleado_nombre,
                color_ruta: ruta.color_ruta,
                tiene_puntos: !!(ruta.puntos && ruta.puntos.length > 0),
                num_puntos: ruta.puntos ? ruta.puntos.length : 0
            });
            
            if (ruta.puntos && ruta.puntos.length > 0) {
                console.log('üìç Procesando puntos de la ruta');
                
                try {
                    const coordinates = ruta.puntos.map(punto => {
                        if (Array.isArray(punto)) {
                            // Si es un array [lat, lon]
                            return punto;
                        } else if (punto.lat && punto.lon) {
                            // Si es un objeto {lat, lon}
                            return [punto.lat, punto.lon];
                        } else {
                            console.warn('‚ö†Ô∏è Formato de punto no reconocido:', punto);
                            return null;
                        }
                    }).filter(coord => coord !== null);
                    
                    console.log('üìç Coordenadas procesadas:', coordinates.length);
                    console.log('üìç Primeras coordenadas:', coordinates.slice(0, 3));
                    
                    if (coordinates.length > 0) {
                        const routeLine = L.polyline(coordinates, {
                            color: ruta.color_ruta || '#e74c3c',
                            weight: 4,
                            opacity: 0.8
                        }).addTo(currentMap);
                        console.log('‚úÖ L√≠nea de ruta agregada al mapa');
                        
                        // Add markers for start and end points
                        if (coordinates.length > 0) {
                            L.marker(coordinates[0]).addTo(currentMap)
                                .bindPopup(`<b>Inicio - ${ruta.empleado_nombre}</b>`);
                            console.log('üìç Marcador de inicio agregado');
                            
                            L.marker(coordinates[coordinates.length - 1]).addTo(currentMap)
                                .bindPopup(`<b>Fin - ${ruta.empleado_nombre}</b>`);
                            console.log('üìç Marcador de fin agregado');
                        }
                        
                        // Fit map to route bounds
                        currentMap.fitBounds(routeLine.getBounds());
                        console.log('‚úÖ Mapa ajustado a los l√≠mites de la ruta');
                    } else {
                        console.warn('‚ö†Ô∏è No hay coordenadas v√°lidas para la ruta');
                    }
                } catch (error) {
                    console.error('‚ùå Error al agregar ruta al mapa:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è La ruta no tiene puntos o est√° vac√≠a');
                console.log('üìä Datos de la ruta:', ruta);
            }
        }

        // Set view mode (individual or shared)
        function setViewMode(mode) {
            console.log('üîÑ Cambiando modo de vista de', currentViewMode, 'a', mode);
            currentViewMode = mode;
            
            // Update button states
            document.getElementById('btnIndividual').classList.toggle('active', mode === 'individual');
            document.getElementById('btnShared').classList.toggle('active', mode === 'shared');
            
            // Re-render map with new mode
            if (currentRouteData) {
                console.log('üó∫Ô∏è Re-renderizando mapa con nuevo modo:', mode);
                
                if (mode === 'individual') {
                    // Force manual rendering for individual mode to filter routes
                    console.log('üë§ Forzando renderizado manual para modo individual');
                    renderManualMap(currentRouteData);
                } else {
                    // Use optimized HTML for shared mode if available, otherwise manual
                    console.log('üë• Usando renderizado optimizado/manual para modo compartido');
                    renderMap(currentRouteData);
                }
            } else {
                console.warn('‚ö†Ô∏è No hay datos de ruta para re-renderizar');
            }
        }



        // Show/hide loading
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('show');
            } else {
                spinner.classList.remove('show');
            }
        }

        // Show message
        function showMessage(message, type) {
            // Create a simple alert for now
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // ============================
        // FUNCIONES DE CHAT
        // ============================

        // Initialize chat for a route
        function initializeChat(routeId) {
            console.log('üí¨ Inicializando chat para ruta:', routeId);
            currentChatRouteId = routeId;
            
            // Show chat elements
            document.getElementById('quickActions').style.display = 'flex';
            document.getElementById('chatInput').style.display = 'block';
            
            // Load chat messages
            loadChatMessages(routeId);
            
            // Start periodic check for new messages
            startChatPolling();
            
            // Setup event listeners
            setupChatEventListeners();
        }

        // Load chat messages
        function loadChatMessages(routeId) {
            console.log('üì• Cargando mensajes del chat...');
            
            fetch('/accounts/chat/obtener_mensajes/', {
                method: 'POST',
                body: JSON.stringify({ 'ruta_id': routeId }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Mensajes cargados:', data.mensajes.length);
                    displayMessages(data.mensajes);
                    
                    // Update last message ID
                    if (data.mensajes.length > 0) {
                        lastMessageId = Math.max(...data.mensajes.map(m => m.id));
                    }
                } else {
                    console.error('‚ùå Error cargando mensajes:', data.error);
                    showMessage('Error al cargar mensajes del chat', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error en fetch de mensajes:', error);
                showMessage('Error de conexi√≥n al cargar chat', 'error');
            });
        }

        // Display messages in chat
        function displayMessages(mensajes) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (mensajes.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <p>No hay mensajes a√∫n. ¬°S√© el primero en escribir!</p>
                    </div>
                `;
                return;
            }
            
            let messagesHTML = '';
            mensajes.forEach(mensaje => {
                messagesHTML += createMessageHTML(mensaje);
            });
            
            chatMessages.innerHTML = messagesHTML;
            scrollToBottom();
        }

        // Create HTML for a single message
        function createMessageHTML(mensaje) {
            const messageClass = mensaje.tipo_mensaje === 'sistema' ? 'system' : 
                                mensaje.es_propio ? 'own' : 'other';
            
            const userIcon = mensaje.usuario.role === 'staff' ? 'üë®‚Äçüíº' : 'üë®‚Äçüîß';
            const userName = mensaje.es_propio ? 'T√∫' : mensaje.usuario.username;
            
            let messageHeader = '';
            if (mensaje.tipo_mensaje !== 'sistema') {
                messageHeader = `<div class="message-header">${userIcon} ${userName}</div>`;
            }
            
            return `
                <div class="message ${messageClass}" data-message-id="${mensaje.id}">
                    ${messageHeader}
                    <div class="message-content">${mensaje.contenido}</div>
                    <div class="message-time">${mensaje.tiempo_relativo}</div>
                </div>
            `;
        }

        // Send message
        function sendMessage(contenido, tipo = 'texto') {
            if (!contenido.trim() || !currentChatRouteId) {
                return;
            }
            
            console.log('üì§ Enviando mensaje:', contenido);
            
            fetch('/accounts/chat/enviar_mensaje/', {
                method: 'POST',
                body: JSON.stringify({
                    'ruta_id': currentChatRouteId,
                    'contenido': contenido.trim(),
                    'tipo_mensaje': tipo
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Mensaje enviado correctamente');
                    appendMessage(data.mensaje);
                    lastMessageId = Math.max(lastMessageId, data.mensaje.id);
                    
                    // Clear input
                    const messageInput = document.getElementById('messageInput');
                    if (messageInput) {
                        messageInput.value = '';
                    }
                } else {
                    console.error('‚ùå Error enviando mensaje:', data.error);
                    showMessage('Error al enviar mensaje: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error en fetch de env√≠o:', error);
                showMessage('Error de conexi√≥n al enviar mensaje', 'error');
            });
        }

        // Append new message to chat
        function appendMessage(mensaje) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove "no messages" placeholder if exists
            const placeholder = chatMessages.querySelector('.text-center.text-muted');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Add new message
            chatMessages.insertAdjacentHTML('beforeend', createMessageHTML(mensaje));
            scrollToBottom();
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Start polling for new messages
        function startChatPolling() {
            // Clear existing interval
            if (chatCheckInterval) {
                clearInterval(chatCheckInterval);
            }
            
            // Check for new messages every 5 seconds
            chatCheckInterval = setInterval(() => {
                if (currentChatRouteId) {
                    checkForNewMessages();
                }
            }, 5000);
        }

        // Check for new messages
        function checkForNewMessages() {
            fetch('/accounts/chat/verificar_nuevos/', {
                method: 'POST',
                body: JSON.stringify({
                    'ruta_id': currentChatRouteId,
                    'ultimo_mensaje_id': lastMessageId
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.hay_nuevos) {
                    console.log('üì® Nuevos mensajes recibidos:', data.mensajes_nuevos.length);
                    
                    // Append new messages
                    data.mensajes_nuevos.forEach(mensaje => {
                        appendMessage(mensaje);
                        lastMessageId = Math.max(lastMessageId, mensaje.id);
                    });
                    
                    // Update badge if there are unread messages
                    updateChatBadge(data.mensajes_no_leidos);
                }
            })
            .catch(error => {
                console.error('‚ùå Error verificando mensajes nuevos:', error);
            });
        }

        // Update chat badge
        function updateChatBadge(count) {
            const badge = document.getElementById('chatBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        // Setup chat event listeners
        function setupChatEventListeners() {
            // Quick message buttons
            document.querySelectorAll('.quick-msg-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const message = this.dataset.message;
                    sendMessage(message, 'rapido');
                });
            });
            
            // Send message button
            document.getElementById('sendMessageBtn').addEventListener('click', function() {
                const messageInput = document.getElementById('messageInput');
                sendMessage(messageInput.value);
            });
            
            // Enter key in message input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(this.value);
                }
            });
        }

        // Funci√≥n para confirmar logout
        function confirmLogout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                window.location.href = '/accounts/logout/';
            }
        }

        // ============================
        // FUNCIONES PARA RUTAS ASIGNADAS
        // ============================

        // Cargar mis rutas asignadas
        function cargarMisRutas() {
            console.log('üîÑ Cargando mis rutas asignadas...');
            
            const container = document.getElementById('misRutasContainer');
            container.innerHTML = `
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando mis rutas...</p>
                </div>
            `;
            
            fetch('/accounts/api/rutas_empleado/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üìä Rutas recibidas:', data);
                
                if (data.success) {
                    if (data.rutas && data.rutas.length > 0) {
                        mostrarRutasAsignadas(data.rutas);
                    } else {
                        mostrarNoRutas();
                    }
                } else {
                    console.error('‚ùå Error cargando rutas:', data.error);
                    mostrarErrorCarga(data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Error en fetch de rutas:', error);
                mostrarErrorCarga('Error de conexi√≥n');
            });
        }

        // Mostrar rutas asignadas
        function mostrarRutasAsignadas(rutas) {
            console.log('üìã Mostrando rutas asignadas:', rutas.length);
            
            const container = document.getElementById('misRutasContainer');
            let html = '';
            
            rutas.forEach(ruta => {
                const estadoClass = ruta.estado === 'completada' ? 'completada' : 'pendiente';
                const estadoText = ruta.estado === 'completada' ? 'Completada' : 'Pendiente';
                
                html += `
                    <div class="ruta-card">
                        <div class="ruta-header">
                            <h4 class="ruta-title">${ruta.colonia}</h4>
                            <span class="ruta-estado ${estadoClass}">${estadoText}</span>
                        </div>
                        <div class="ruta-info">
                            <div class="ruta-info-item">
                                <span class="ruta-info-label">Distancia:</span>
                                <span class="ruta-info-value">${ruta.distancia_km.toFixed(2)} km</span>
                            </div>
                            <div class="ruta-info-item">
                                <span class="ruta-info-label">Nodos:</span>
                                <span class="ruta-info-value">${ruta.num_nodos}</span>
                            </div>
                            <div class="ruta-info-item">
                                <span class="ruta-info-label">Tiempo Estimado:</span>
                                <span class="ruta-info-value">${ruta.tiempo_estimado.toFixed(1)} hrs</span>
                            </div>
                            <div class="ruta-info-item">
                                <span class="ruta-info-label">Asignada:</span>
                                <span class="ruta-info-value">${ruta.fecha_asignacion}</span>
                            </div>
                            ${ruta.tiempo_real ? `
                                <div class="ruta-info-item">
                                    <span class="ruta-info-label">Tiempo Real:</span>
                                    <span class="ruta-info-value">${(ruta.tiempo_real / 60).toFixed(1)} hrs</span>
                                </div>
                                <div class="ruta-info-item">
                                    <span class="ruta-info-label">Eficiencia:</span>
                                    <span class="ruta-info-value">${ruta.eficiencia.toFixed(1)}%</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="ruta-actions">
                            <button class="btn-ver-detalles" onclick="verDetallesRuta(${ruta.id})">
                                <i class="fas fa-eye"></i> Ver Detalles
                            </button>
                            ${ruta.estado === 'pendiente' ? `
                                <button class="btn-completar" onclick="abrirModalCompletar(${ruta.id}, '${ruta.colonia}')">
                                    <i class="fas fa-check"></i> Completar
                                </button>
                            ` : `
                                <button class="btn-completar" disabled>
                                    <i class="fas fa-check"></i> Completada
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('‚úÖ Rutas mostradas correctamente');
        }

        // Mostrar mensaje de no hay rutas
        function mostrarNoRutas() {
            console.log('üì≠ No hay rutas asignadas');
            
            const container = document.getElementById('misRutasContainer');
            container.innerHTML = `
                <div class="no-rutas-message">
                    <i class="fas fa-route"></i>
                    <h3>No tienes rutas asignadas</h3>
                    <p>Contacta con tu supervisor para que te asigne una ruta de trabajo.</p>
                </div>
            `;
        }

        // Mostrar error de carga
        function mostrarErrorCarga(error) {
            console.log('‚ùå Error de carga:', error);
            
            const container = document.getElementById('misRutasContainer');
            container.innerHTML = `
                <div class="no-rutas-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error al cargar rutas</h3>
                    <p>${error}</p>
                    <button class="refresh-btn" onclick="cargarMisRutas()">
                        <i class="fas fa-sync-alt"></i> Intentar de nuevo
                    </button>
                </div>
            `;
        }

        // Ver detalles de ruta
        function verDetallesRuta(rutaId) {
            console.log('üëÅÔ∏è Ver detalles de ruta:', rutaId);
            
            // Cargar la ruta en el selector principal
            const routeSelector = document.getElementById('routeSelector');
            if (routeSelector) {
                routeSelector.value = rutaId;
                loadRouteData(rutaId);
                
                // Scroll hacia la secci√≥n del mapa
                document.querySelector('.dashboard-grid').scrollIntoView({
                    behavior: 'smooth'
                });
            }
        }

        // Abrir modal para completar ruta
        function abrirModalCompletar(rutaId, colonia) {
            console.log('üìù Abriendo modal para completar ruta:', rutaId, colonia);
            
            // Guardar el ID de la ruta en el modal
            document.getElementById('completarRutaModal').dataset.rutaId = rutaId;
            
            // Llenar datos del modal
            document.getElementById('modalColonia').value = colonia;
            document.getElementById('modalTiempoReal').value = '';
            document.getElementById('modalFechaInicio').value = '';
            document.getElementById('modalNotas').value = '';
            
            // Mostrar modal
            document.getElementById('completarRutaModal').style.display = 'flex';
        }

        // Cerrar modal de completar
        function cerrarModalCompletar() {
            console.log('‚ùå Cerrando modal de completar');
            document.getElementById('completarRutaModal').style.display = 'none';
        }

        // Marcar ruta como completada
        function marcarRutaCompletada(rutaId, tiempoReal, fechaInicio, notas) {
            console.log('‚úÖ Marcando ruta como completada:', {
                rutaId,
                tiempoReal,
                fechaInicio,
                notas
            });
            
            const data = {
                configuracion_ruta_id: rutaId,
                tiempo_real_minutos: tiempoReal,
                fecha_inicio: fechaInicio,
                notas: notas
            };
            
            fetch('/accounts/api/marcar_ruta_completada/', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Ruta marcada como completada exitosamente');
                    alert(`¬°Ruta completada exitosamente!\nTiempo real: ${data.tiempo_real} minutos\nEficiencia: ${data.eficiencia.toFixed(1)}%`);
                    
                    // Cerrar modal
                    cerrarModalCompletar();
                    
                    // Recargar rutas
                    cargarMisRutas();
                } else {
                    console.error('‚ùå Error marcando ruta como completada:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Error en fetch de completar ruta:', error);
                alert('Error de conexi√≥n al marcar ruta como completada');
            });
        }


    </script>
</body>
</html> 